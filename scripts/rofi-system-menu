#!/usr/bin/env bash
# Rofi System Menu - Inspired by Omarchy Walker
# Comprehensive system management through Rofi

set -euo pipefail

# Set PATH to include common directories
export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Removed rofi styling variables - using default theme

# Color variables for notifications
declare -r SUCCESS_COLOR="#66800B"
declare -r ERROR_COLOR="#AF3029"
declare -r INFO_COLOR="#4385BE"

notify_success() {
    notify-send -u normal "System Menu" "$1"
}

notify_error() {
    notify-send -u critical "System Menu" "$1"
}

notify_info() {
    notify-send -u low "System Menu" "$1"
}

show_main_menu() {
    echo "ğŸ¨ Appearance & Theming"
    echo "âš™ï¸  System Settings"
    echo "ğŸ”Œ Power Management"
    echo "ğŸ“± Applications"
    echo "ğŸ”§ Development Tools"
    echo "ğŸ“Š System Information"
    echo "ğŸ”’ Security & Privacy"
    echo "ğŸŒ Network & Connectivity"
    echo "ğŸ“ File Management" 
    echo "â“ Help & About"
}

show_appearance_menu() {
    echo "ğŸ–¼ï¸  Wallpaper Selector"
    echo "ğŸ¨ Flexoki Theme Settings"
    echo "ğŸ”¤ Font Configuration"
    echo "ğŸ–¥ï¸  Display Settings"
    echo "ğŸ­ Icon Themes"
    echo "ğŸŒˆ Color Picker"
    echo "â¬…ï¸  Back to Main Menu"
}

show_system_menu() {
    echo "ğŸ”Š Audio Settings"
    echo "ğŸ“± Bluetooth Management"
    echo "ğŸŒ Network Configuration"
    echo "âŒ¨ï¸  Keyboard & Input"
    echo "ğŸ–±ï¸  Mouse & Touchpad"
    echo "ğŸ• Date & Time"
    echo "ğŸŒ Locale & Language"
    echo "â¬…ï¸  Back to Main Menu"
}

show_power_menu() {
    echo "ğŸ”’ Lock Screen"
    echo "ğŸ’¤ Suspend"
    echo "ğŸ”„ Restart"
    echo "âš¡ Shutdown"
    echo "ğŸšª Log Out"
    echo "ğŸ”‹ Power Profile"
    echo "â¬…ï¸  Back to Main Menu"
}

show_apps_menu() {
    echo "ğŸ“ Text Editors"
    echo "ğŸŒ Web Browsers"
    echo "ğŸ“ File Managers"
    echo "ğŸµ Media Players"
    echo "ğŸ’¬ Communication"
    echo "ğŸ® Games"
    echo "ğŸ“· Graphics & Photography"
    echo "â¬…ï¸  Back to Main Menu"
}

show_dev_menu() {
    echo "ğŸ’» Terminal"
    echo "ğŸ“ Code Editors"
    echo "ğŸ”§ Package Manager"
    echo "ğŸ™ Git Tools"
    echo "ğŸ³ Docker"
    echo "ğŸ“¦ Node.js Tools"
    echo "ğŸ Python Tools"
    echo "ğŸ¦€ Rust Tools"
    echo "â¬…ï¸  Back to Main Menu"
}

show_info_menu() {
    echo "ğŸ’» System Information"
    echo "ğŸ“Š Resource Monitor"
    echo "ğŸŒ¡ï¸  Temperature Monitor"
    echo "ğŸ’¾ Disk Usage"
    echo "ğŸ”Œ Hardware Info"
    echo "ğŸ“¡ Network Status"
    echo "ğŸ“‹ Clipboard History"
    echo "â¬…ï¸  Back to Main Menu"
}

show_security_menu() {
    echo "ğŸ”’ SSH Key Management"
    echo "ğŸ” Password Manager"
    echo "ğŸ›¡ï¸  Firewall Status"
    echo "ğŸš« Fail2ban Status"
    echo "ğŸ”— Tailscale Status"
    echo "ğŸ” Security Scan"
    echo "â¬…ï¸  Back to Main Menu"
}

show_network_menu() {
    echo "ğŸ“¶ WiFi Networks"
    echo "ğŸ”— Ethernet Settings"
    echo "ğŸŒ DNS Configuration"
    echo "ğŸ”’ VPN Connections"
    echo "ğŸšª Port Scanner"
    echo "ğŸ“Š Network Monitor"
    echo "â¬…ï¸  Back to Main Menu"
}

show_file_menu() {
    echo "ğŸ“ File Manager (Yazi)"
    echo "ğŸ” File Search"
    echo "ğŸ“‹ Recent Files"
    echo "ğŸ—‘ï¸  Trash Management"
    echo "ğŸ’¾ Disk Analyzer"
    echo "ğŸ”„ Sync & Backup"
    echo "â¬…ï¸  Back to Main Menu"
}

# Appearance functions
handle_wallpaper() {
    "$SCRIPT_DIR/rofi-wallpaper"
}

handle_display_settings() {
    if command -v arandr >/dev/null 2>&1; then
        arandr &
    elif command -v xrandr >/dev/null 2>&1; then
        local output
        output=$(xrandr --listmonitors | rofi -dmenu -p "Select display:")
        if [ -n "$output" ]; then
            notify_info "Display configuration options would go here"
        fi
    else
        notify_error "No display configuration tool found"
    fi
}

handle_color_picker() {
    if command -v hyprpicker >/dev/null 2>&1; then
        local color
        color=$(hyprpicker -a)
        notify_success "Color copied to clipboard: $color"
    elif command -v gcolor3 >/dev/null 2>&1; then
        gcolor3 &
    else
        notify_error "No color picker found. Install hyprpicker or gcolor3"
    fi
}

# Power functions
handle_lock() {
    if command -v hyprlock >/dev/null 2>&1; then
        hyprlock
    else
        notify_error "hyprlock not found"
    fi
}

handle_suspend() {
    local confirm
    confirm=$(echo -e "Yes\nNo" | rofi -dmenu -p "Suspend system?")
    if [ "$confirm" = "Yes" ]; then
        systemctl suspend
    fi
}

handle_restart() {
    local confirm
    confirm=$(echo -e "Yes\nNo" | rofi -dmenu -p "Restart system?")
    if [ "$confirm" = "Yes" ]; then
        systemctl reboot
    fi
}

handle_shutdown() {
    local confirm
    confirm=$(echo -e "Yes\nNo" | rofi -dmenu -p "Shutdown system?")
    if [ "$confirm" = "Yes" ]; then
        systemctl poweroff
    fi
}

handle_logout() {
    local confirm
    confirm=$(echo -e "Yes\nNo" | rofi -dmenu -p "Log out?")
    if [ "$confirm" = "Yes" ]; then
        hyprctl dispatch exit
    fi
}

# System info functions
handle_system_info() {
    if command -v fastfetch >/dev/null 2>&1; then
        alacritty -e fastfetch &
    elif command -v neofetch >/dev/null 2>&1; then
        alacritty -e neofetch &
    else
        notify_error "No system info tool found"
    fi
}

handle_resource_monitor() {
    if command -v btop >/dev/null 2>&1; then
        alacritty -e btop &
    elif command -v htop >/dev/null 2>&1; then
        alacritty -e htop &
    else
        notify_error "No system monitor found"
    fi
}

handle_disk_usage() {
    if command -v duf >/dev/null 2>&1; then
        alacritty -e duf &
    elif command -v df >/dev/null 2>&1; then
        alacritty -e df -h &
    else
        notify_error "No disk usage tool found"
    fi
}

# Network functions
handle_wifi() {
    if command -v nmtui >/dev/null 2>&1; then
        alacritty -e nmtui &
    else
        notify_error "NetworkManager TUI not found"
    fi
}

handle_tailscale_status() {
    if command -v tailscale >/dev/null 2>&1; then
        local status
        status=$(tailscale status 2>/dev/null || echo "Tailscale not connected")
        echo "$status" | rofi -dmenu -p "Tailscale Status:"
    else
        notify_error "Tailscale not installed"
    fi
}

# File management functions
handle_file_manager() {
    alacritty -e yazi &
}

handle_file_search() {
    if command -v fd >/dev/null 2>&1; then
        local query
        query=$(rofi -dmenu -p "Search for file:")
        if [ -n "$query" ]; then
            local result
            result=$(fd "$query" ~ | head -20 | rofi -dmenu -p "Select file:")
            if [ -n "$result" ] && [ -f "$result" ]; then
                xdg-open "$result" &
            fi
        fi
    else
        notify_error "fd (file finder) not installed"
    fi
}

# Main menu handler
handle_menu_choice() {
    local choice="$1"
    case "$choice" in
        "ğŸ¨ Appearance & Theming")
            local subchoice
            subchoice=$(show_appearance_menu | rofi -dmenu -i -p "Appearance:")
            case "$subchoice" in
                "ğŸ–¼ï¸  Wallpaper Selector") handle_wallpaper ;;
                "ğŸ–¥ï¸  Display Settings") handle_display_settings ;;
                "ğŸŒˆ Color Picker") handle_color_picker ;;
                "â¬…ï¸  Back to Main Menu") main ;;
            esac
            ;;
        "ğŸ”Œ Power Management")
            local subchoice
            subchoice=$(show_power_menu | rofi -dmenu -i -p "Power:")
            case "$subchoice" in
                "ğŸ”’ Lock Screen") handle_lock ;;
                "ğŸ’¤ Suspend") handle_suspend ;;
                "ğŸ”„ Restart") handle_restart ;;
                "âš¡ Shutdown") handle_shutdown ;;
                "ğŸšª Log Out") handle_logout ;;
                "â¬…ï¸  Back to Main Menu") main ;;
            esac
            ;;
        "ğŸ“Š System Information")
            local subchoice
            subchoice=$(show_info_menu | rofi -dmenu -i -p "System Info:")
            case "$subchoice" in
                "ğŸ’» System Information") handle_system_info ;;
                "ğŸ“Š Resource Monitor") handle_resource_monitor ;;
                "ğŸ’¾ Disk Usage") handle_disk_usage ;;
                "â¬…ï¸  Back to Main Menu") main ;;
            esac
            ;;
        "ğŸŒ Network & Connectivity")
            local subchoice
            subchoice=$(show_network_menu | rofi -dmenu -i -p "Network:")
            case "$subchoice" in
                "ğŸ“¶ WiFi Networks") handle_wifi ;;
                "ğŸ”— Tailscale Status") handle_tailscale_status ;;
                "â¬…ï¸  Back to Main Menu") main ;;
            esac
            ;;
        "ğŸ“ File Management")
            local subchoice
            subchoice=$(show_file_menu | rofi -dmenu -i -p "Files:")
            case "$subchoice" in
                "ğŸ“ File Manager (Yazi)") handle_file_manager ;;
                "ğŸ” File Search") handle_file_search ;;
                "â¬…ï¸  Back to Main Menu") main ;;
            esac
            ;;
        "â“ Help & About")
            echo -e "System Menu v1.0\nRofi-based system management\nInspired by Omarchy Walker\n\nKeybinds:\nSuper+D - App Launcher\nSuper+Alt+Space - System Menu" | \
                rofi -dmenu -p "About:"
            ;;
    esac
}

main() {
    local choice
    choice=$(show_main_menu | rofi -dmenu -i -p "System Menu:")
    
    if [ -n "$choice" ]; then
        handle_menu_choice "$choice"
    fi
}

# Handle command line arguments
case "${1:-}" in
    --wallpaper)
        handle_wallpaper
        ;;
    --power)
        show_power_menu | rofi -dmenu -i -p "Power:"
        ;;
    *)
        main
        ;;
esac